<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Course - Kohza</title>
    <script type="module">
        // Redirect to the new multi-step course creation flow
        import { utils } from './supabase-client.js';
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication first
            const { user, profile, hasRequiredRole } = await utils.requireAuth('coach');
            
            if (user && profile && hasRequiredRole) {
                // If authenticated as coach, redirect to step 1
                window.location.href = 'create-course-step1.html';
            }
            // If not authenticated, requireAuth will handle the redirect
        });
    </script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="create-course.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        purple: {
                            DEFAULT: '#9333ea', '50': '#faf5ff', '100': '#f3e8ff', '200': '#e9d5ff', '300': '#d8b4fe', '400': '#c084fc', '500': '#a855f7', '600': '#9333ea', '700': '#7e22ce', '800': '#6b21a8', '900': '#581c87', '950': '#3b0764'
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="antialiased">

    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 bg-blobs">
        <div
            class="absolute w-[80vmax] h-[80vmax] -left-[40vmax] -top-[40vmax] bg-purple-900/40 rounded-full blur-3xl opacity-50">
        </div>
    </div>

    <div class="relative z-10 flex flex-col items-center justify-center min-h-screen p-4">

        <header class="absolute top-0 left-0 right-0 p-6 sm:p-8 flex justify-between items-center">
            <a href="coach-admin-panel.html"
                class="nav-link text-gray-300 hover:text-white transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                        clip-rule="evenodd" />
                </svg>
                Back to Dashboard
            </a>
            <button id="theme-toggle" type="button"
                class="theme-toggle-btn text-gray-400 hover:text-white focus:outline-none p-2 rounded-md">
                <svg id="theme-icon-dark" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                    </path>
                </svg>
                <svg id="theme-icon-light" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                    </path>
                </svg>
            </button>
        </header>

        <main class="w-full max-w-6xl">
            <!-- Progress Steps -->
            <div class="mb-8">
                <div class="flex items-center justify-center space-x-4">
                    <div class="flex items-center">
                        <div
                            class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white font-semibold">
                            1</div>
                        <span class="ml-2 text-white font-medium">Course Details</span>
                    </div>
                    <div class="w-16 h-1 bg-gray-600"></div>
                    <div class="flex items-center">
                        <div
                            class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center text-gray-400 font-semibold">
                            2</div>
                        <span class="ml-2 text-gray-400 font-medium">Modules & Lessons</span>
                    </div>
                    <div class="w-16 h-1 bg-gray-600"></div>
                    <div class="flex items-center">
                        <div
                            class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center text-gray-400 font-semibold">
                            3</div>
                        <span class="ml-2 text-gray-400 font-medium">Review & Publish</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Course Details Form -->
                <div class="lg:col-span-2">
                    <div
                        class="form-card bg-black/60 backdrop-blur-lg border border-purple-800/50 rounded-xl shadow-lg shadow-purple-950/40 p-8">
                        <div class="mb-8">
                            <h1 class="text-3xl font-serif heading-text">Create Your Course</h1>
                            <p class="text-gray-400 mt-2">Build a comprehensive learning experience with modules and
                                lessons.</p>
                        </div>

                        <form id="create-course-form">
                            <div class="space-y-6">
                                <div>
                                    <label for="title" class="block text-lg font-medium label-text">Course Title</label>
                                    <input id="title" name="title" type="text" required
                                        class="mt-2 w-full px-4 py-3 input-field bg-gray-900/70 border border-gray-700 rounded-md text-white text-xl placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-600"
                                        placeholder="e.g., The Art of Stoic Resilience">
                                </div>

                                <div>
                                    <label for="description" class="block text-lg font-medium label-text">Course
                                        Description</label>
                                    <textarea id="description" name="description" rows="4"
                                        class="mt-2 w-full px-4 py-3 input-field bg-gray-900/70 border border-gray-700 rounded-md text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-600"
                                        placeholder="Describe what students will learn and achieve..."></textarea>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="price" class="block text-lg font-medium label-text">Monthly Price
                                            ($)</label>
                                        <input id="price" name="price" type="number" min="0" step="1" required
                                            class="mt-2 w-full px-4 py-3 input-field bg-gray-900/70 border border-gray-700 rounded-md text-white text-xl placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-600"
                                            placeholder="99">
                                    </div>
                                    <div>
                                        <label for="duration" class="block text-lg font-medium label-text">Estimated
                                            Duration (hours)</label>
                                        <input id="duration" name="duration" type="number" min="1" step="0.5"
                                            class="mt-2 w-full px-4 py-3 input-field bg-gray-900/70 border border-gray-700 rounded-md text-white text-xl placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-600"
                                            placeholder="10">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-lg font-medium label-text">Course Thumbnail</label>
                                    <div class="mt-2 flex items-center gap-6">
                                        <img id="thumbnail-preview"
                                            src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDA4IiBoZWlnaHQ9IjI0MCIgdmlld0JveD0iMCAwIDQwOCAyNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjM2IwNzY0IiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM2YjIxYTgiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMTAxMDEwIiAvPgogIDxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZykiIG9wYWNpdHk9IjAuNSIgLz4KICA8cGF0aCBkPSJNMjU2IDgwbC00OCAyOC00OC0yOC00OCAyOCAwIDU2IDQ4IDI4IDQ4LTI4IDQ4IDI4IDAtNTZ6TTIwOCAxMDhsNDggMjggMCAwLTE2LTktNDgtMjh6TTIwOCAxMDhsLTQ4IDI4djI4bDE2LTkgNDgtMjh6IiBmaWxsPSIjZTNlOGZmIiBmaWxsLW9wYWNpdHk9IjAuMSIgLz4KICA8dGV4dCB4PSI1MCIgeT0iNTAlIiBmb250LWZhbWlseT0iSW50ZXIsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiNhMGE5YmUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJjZW50cmFsIj5LZWh6YTwvdGV4dD4KPC9zdmc+"
                                            alt="Thumbnail preview"
                                            class="h-24 w-40 object-cover rounded-md bg-gray-800 border border-gray-700 thumbnail-preview">
                                        <label for="thumbnail-upload"
                                            class="cursor-pointer upload-button bg-white/10 border border-white/20 px-5 py-2.5 rounded-md text-white font-semibold hover:bg-white/20 transition-colors duration-300">
                                            <span>Upload Image</span>
                                            <input id="thumbnail-upload" name="thumbnail" type="file" class="sr-only"
                                                accept="image/png, image/jpeg, image/webp">
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Modules Section -->
                    <div
                        class="mt-8 form-card bg-black/60 backdrop-blur-lg border border-purple-800/50 rounded-xl shadow-lg shadow-purple-950/40 p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-serif text-white">Course Modules</h2>
                            <button id="add-module-btn"
                                class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md font-medium transition-colors">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Add Module
                            </button>
                        </div>

                        <div id="modules-container" class="space-y-4">
                            <!-- Modules will be added here dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Course Preview Sidebar -->
                <div class="lg:col-span-1">
                    <div class="sticky top-8">
                        <div
                            class="form-card bg-black/60 backdrop-blur-lg border border-purple-800/50 rounded-xl shadow-lg shadow-purple-950/40 p-6">
                            <h3 class="text-xl font-serif text-white mb-4">Course Preview</h3>

                            <div class="space-y-4">
                                <div class="aspect-video bg-gray-800 rounded-lg overflow-hidden">
                                    <img id="preview-thumbnail"
                                        src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDA4IiBoZWlnaHQ9IjI0MCIgdmlld0JveD0iMCAwIDQwOCAyNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjM2IwNzY0IiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM2YjIxYTgiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMTAxMDEwIiAvPgogIDxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZykiIG9wYWNpdHk9IjAuNSIgLz4KICA8cGF0aCBkPSJNMjU2IDgwbC00OCAyOC00OC0yOC00OCAyOCAwIDU2IDQ4IDI4IDQ4LTI4IDQ4IDI4IDAtNTZ6TTIwOCAxMDhsNDggMjggMCAwLTE2LTktNDgtMjh6TTIwOCAxMDhsLTQ4IDI4djI4bDE2LTkgNDgtMjh6IiBmaWxsPSIjZTNlOGZmIiBmaWxsLW9wYWNpdHk9IjAuMSIgLz4KICA8dGV4dCB4PSI1MCIgeT0iNTAlIiBmb250LWZhbWlseT0iSW50ZXIsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiNhMGE5YmUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJjZW50cmFsIj5LZWh6YTwvdGV4dD4KPC9zdmc+"
                                        alt="Course thumbnail" class="w-full h-full object-cover">
                                </div>

                                <div>
                                    <h4 id="preview-title" class="text-lg font-semibold text-white">Course Title</h4>
                                    <p id="preview-description" class="text-gray-400 text-sm mt-1">Course description
                                        will appear here...</p>
                                </div>

                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-400">Price:</span>
                                    <span id="preview-price" class="text-purple-400 font-semibold">$0/month</span>
                                </div>

                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-400">Duration:</span>
                                    <span id="preview-duration" class="text-gray-300">0 hours</span>
                                </div>

                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-400">Modules:</span>
                                    <span id="preview-modules" class="text-gray-300">0</span>
                                </div>

                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-400">Lessons:</span>
                                    <span id="preview-lessons" class="text-gray-300">0</span>
                                </div>
                            </div>

                            <div class="mt-6 pt-6 border-t border-gray-700">
                                <button id="create-course-btn"
                                    class="w-full py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-bold text-white bg-purple-700 hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-black focus:ring-purple-500 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Create Course
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script type="module">
        import { auth, db, utils, supabase } from './supabase-client.js';

        let courseModules = [];
        let moduleCounter = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('üîç Checking authentication for course creation...');
                
                // Check authentication and role
                const authData = await utils.requireAuth('coach');
                
                if (!authData || !authData.user) {
                    console.log('‚ùå Authentication failed, redirecting to login');
                    return; // requireAuth will handle redirect
                }

                const { user, profile } = authData;
                console.log('‚úÖ User authenticated for course creation:', user.email);
                console.log('üë§ Profile:', profile);
                
                initializePage(user, profile);
                
            } catch (error) {
                console.error('‚ùå Authentication error:', error);
                window.location.href = 'login.html';
            }
        });

        function initializePage(user, profile) {
            const thumbnailInput = document.getElementById('thumbnail-upload');
            const thumbnailPreview = document.getElementById('thumbnail-preview');
            const previewThumbnail = document.getElementById('preview-thumbnail');

            // Form elements
            const titleInput = document.getElementById('title');
            const descriptionInput = document.getElementById('description');
            const priceInput = document.getElementById('price');
            const durationInput = document.getElementById('duration');

            // Preview elements
            const previewTitle = document.getElementById('preview-title');
            const previewDescription = document.getElementById('preview-description');
            const previewPrice = document.getElementById('preview-price');
            const previewDuration = document.getElementById('preview-duration');
            const previewModules = document.getElementById('preview-modules');
            const previewLessons = document.getElementById('preview-lessons');

            // Update preview in real-time
            function updatePreview() {
                previewTitle.textContent = titleInput.value || 'Course Title';
                previewDescription.textContent = descriptionInput.value || 'Course description will appear here...';
                previewPrice.textContent = `$${priceInput.value || 0}/month`;
                previewDuration.textContent = `${durationInput.value || 0} hours`;
                previewModules.textContent = courseModules.length;

                const totalLessons = courseModules.reduce((total, module) => total + module.lessons.length, 0);
                previewLessons.textContent = totalLessons;
            }

            // Event listeners for real-time preview
            titleInput.addEventListener('input', updatePreview);
            descriptionInput.addEventListener('input', updatePreview);
            priceInput.addEventListener('input', updatePreview);
            durationInput.addEventListener('input', updatePreview);

            // Preview thumbnail image
            thumbnailInput.addEventListener('change', () => {
                const file = thumbnailInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        thumbnailPreview.src = e.target.result;
                        previewThumbnail.src = e.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });

            // Add module functionality
            document.getElementById('add-module-btn').addEventListener('click', () => {
                addModule();
            });

            // Handle course creation
            document.getElementById('create-course-btn').addEventListener('click', async () => {
                await createCourse(user);
            });

            // Initialize with one default module
            addModule('Introduction', 'Welcome to your course');
        }

        function addModule(title = '', description = '') {
            moduleCounter++;
            const moduleId = `module-${moduleCounter}`;

            const module = {
                id: moduleId,
                title: title || `Module ${moduleCounter}`,
                description: description || '',
                lessons: []
            };

            courseModules.push(module);

            const moduleHtml = `
                <div class="module-card bg-gray-800/50 border border-gray-700 rounded-lg p-6" data-module-id="${moduleId}">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-white">Module ${courseModules.length}</h3>
                        <div class="flex items-center space-x-2">
                            <button class="add-lesson-btn text-purple-400 hover:text-purple-300 text-sm font-medium">
                                + Add Lesson
                            </button>
                            <button class="remove-module-btn text-red-400 hover:text-red-300 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <input type="text" class="module-title w-full px-3 py-2 bg-gray-900/70 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-600" placeholder="Module title" value="${module.title}">
                        </div>
                        <div>
                            <textarea class="module-description w-full px-3 py-2 bg-gray-900/70 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-600" rows="2" placeholder="Module description">${module.description}</textarea>
                        </div>
                        
                        <div class="lessons-container space-y-2">
                            <!-- Lessons will be added here -->
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modules-container').insertAdjacentHTML('beforeend', moduleHtml);

            // Add event listeners for the new module
            const moduleCard = document.querySelector(`[data-module-id="${moduleId}"]`);

            moduleCard.querySelector('.module-title').addEventListener('input', (e) => {
                module.title = e.target.value;
                updatePreview();
            });

            moduleCard.querySelector('.module-description').addEventListener('input', (e) => {
                module.description = e.target.value;
            });

            moduleCard.querySelector('.add-lesson-btn').addEventListener('click', () => {
                addLesson(moduleId);
            });

            moduleCard.querySelector('.remove-module-btn').addEventListener('click', () => {
                removeModule(moduleId);
            });

            updatePreview();
        }

        function addLesson(moduleId) {
            const module = courseModules.find(m => m.id === moduleId);
            if (!module) return;

            const lessonId = `lesson-${Date.now()}`;
            const lesson = {
                id: lessonId,
                title: `Lesson ${module.lessons.length + 1}`,
                duration: 10
            };

            module.lessons.push(lesson);

            const lessonHtml = `
                <div class="lesson-item bg-gray-900/50 border border-gray-600 rounded-md p-3 flex items-center justify-between" data-lesson-id="${lessonId}">
                    <div class="flex-1">
                        <input type="text" class="lesson-title bg-transparent text-white placeholder-gray-400 focus:outline-none w-full" placeholder="Lesson title" value="${lesson.title}">
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center space-x-1">
                            <input type="number" class="lesson-duration w-16 px-2 py-1 bg-gray-800 border border-gray-600 rounded text-white text-sm" min="1" value="${lesson.duration}">
                            <span class="text-gray-400 text-sm">min</span>
                        </div>
                        <button class="remove-lesson-btn text-red-400 hover:text-red-300">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;

            const moduleCard = document.querySelector(`[data-module-id="${moduleId}"]`);
            const lessonsContainer = moduleCard.querySelector('.lessons-container');
            lessonsContainer.insertAdjacentHTML('beforeend', lessonHtml);

            // Add event listeners for the new lesson
            const lessonItem = lessonsContainer.querySelector(`[data-lesson-id="${lessonId}"]`);

            lessonItem.querySelector('.lesson-title').addEventListener('input', (e) => {
                lesson.title = e.target.value;
            });

            lessonItem.querySelector('.lesson-duration').addEventListener('input', (e) => {
                lesson.duration = parseInt(e.target.value) || 1;
            });

            lessonItem.querySelector('.remove-lesson-btn').addEventListener('click', () => {
                removeLesson(moduleId, lessonId);
            });

            updatePreview();
        }

        function removeModule(moduleId) {
            courseModules = courseModules.filter(m => m.id !== moduleId);
            document.querySelector(`[data-module-id="${moduleId}"]`).remove();
            updatePreview();
        }

        function removeLesson(moduleId, lessonId) {
            const module = courseModules.find(m => m.id === moduleId);
            if (module) {
                module.lessons = module.lessons.filter(l => l.id !== lessonId);
            }
            document.querySelector(`[data-lesson-id="${lessonId}"]`).remove();
            updatePreview();
        }

        function updatePreview() {
            const previewModules = document.getElementById('preview-modules');
            const previewLessons = document.getElementById('preview-lessons');

            previewModules.textContent = courseModules.length;
            const totalLessons = courseModules.reduce((total, module) => total + module.lessons.length, 0);
            previewLessons.textContent = totalLessons;
        }

        async function createCourse(user) {
            const formData = new FormData(document.getElementById('create-course-form'));
            const title = formData.get('title');
            const description = formData.get('description');
            const price = parseFloat(formData.get('price')) || 0;
            const duration = parseFloat(formData.get('duration')) || 0;
            const thumbnailFile = formData.get('thumbnail');
            const submitButton = document.getElementById('create-course-btn');

            if (!title.trim()) {
                alert('Please enter a course title.');
                return;
            }

            if (courseModules.length === 0) {
                alert('Please add at least one module to your course.');
                return;
            }

            try {
                submitButton.textContent = 'Creating Course...';
                submitButton.disabled = true;

                let thumbnailUrl = null;

                // Upload thumbnail if provided
                if (thumbnailFile && thumbnailFile.size > 0) {
                    const fileExt = thumbnailFile.name.split('.').pop();
                    const fileName = `${user.id}/${Date.now()}.${fileExt}`;

                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('course-thumbnails')
                        .upload(fileName, thumbnailFile);

                    if (uploadError) {
                        console.warn('Thumbnail upload failed:', uploadError);
                    } else {
                        const { data: { publicUrl } } = supabase.storage
                            .from('course-thumbnails')
                            .getPublicUrl(fileName);
                        thumbnailUrl = publicUrl;
                    }
                }

                // Create course in Supabase
                console.log('üìù Creating course with data:', {
                    title: title.trim(),
                    description: description.trim() || null,
                    price: price,
                    coach_id: user.id,
                    published: false,
                    thumbnail_url: thumbnailUrl
                });
                
                const { data: newCourse, error } = await db.createCourse({
                    title: title.trim(),
                    description: description.trim() || null,
                    price: price,
                    coach_id: user.id,
                    published: false,
                    thumbnail_url: thumbnailUrl
                });

                console.log('üìù Course creation result:', { newCourse, error });

                if (error) throw error;

                // Create modules and lessons
                for (let i = 0; i < courseModules.length; i++) {
                    const moduleData = courseModules[i];

                    const { data: newModule, error: moduleError } = await db.createModule({
                        course_id: newCourse.id,
                        title: moduleData.title,
                        description: moduleData.description,
                        order_index: i + 1
                    });

                    if (moduleError) {
                        console.warn('Failed to create module:', moduleError);
                        continue;
                    }

                    // Create lessons for this module
                    for (let j = 0; j < moduleData.lessons.length; j++) {
                        const lessonData = moduleData.lessons[j];

                        const { error: lessonError } = await db.createLesson({
                            module_id: newModule.id,
                            title: lessonData.title,
                            duration: lessonData.duration,
                            order_index: j + 1
                        });

                        if (lessonError) {
                            console.warn('Failed to create lesson:', lessonError);
                        }
                    }
                }

                // Show success message
                alert('Course created successfully with all modules and lessons!');

                // Redirect to course editor
                window.location.href = `course-editor.html?id=${newCourse.id}`;

            } catch (error) {
                console.error('Error creating course:', error);
                alert(`Error creating course: ${error.message || 'Please try again.'}`);

                submitButton.textContent = 'Create Course';
                submitButton.disabled = false;
            }
        }

        // Disable right-click
        document.addEventListener('contextmenu', event => event.preventDefault());
    </script>
    <script>
        // --- THEME SWITCHER ---
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.getElementById('theme-toggle');
            if (!themeToggle) return;

            const darkIcon = document.getElementById('theme-icon-dark');
            const lightIcon = document.getElementById('theme-icon-light');
            const htmlEl = document.documentElement;

            function setTheme(theme) {
                if (theme === 'dark') {
                    htmlEl.setAttribute('data-theme', 'dark');
                    if (darkIcon) darkIcon.classList.remove('hidden');
                    if (lightIcon) lightIcon.classList.add('hidden');
                    localStorage.setItem('theme', 'dark');
                } else {
                    htmlEl.setAttribute('data-theme', 'light');
                    if (darkIcon) darkIcon.classList.add('hidden');
                    if (lightIcon) lightIcon.classList.remove('hidden');
                    localStorage.setItem('theme', 'light');
                }
            }

            themeToggle.addEventListener('click', () => {
                const currentTheme = htmlEl.getAttribute('data-theme');
                setTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });

            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme) {
                setTheme(savedTheme);
            } else if (prefersDark) {
                setTheme('dark');
            } else {
                setTheme('light');
            }
        });
    </script>
</body>

</html>