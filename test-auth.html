<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Authentication - Kohza</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Authentication Test</h1>

        <div class="space-y-6">
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">Current Auth Status</h2>
                <div id="auth-status" class="text-gray-300">Checking...</div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">Quick Login (Coach)</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Email</label>
                        <input type="email" id="email" required
                            class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                            placeholder="coach@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Password</label>
                        <input type="password" id="password" required
                            class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                            placeholder="password">
                    </div>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-white">
                        Login
                    </button>
                </form>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">Quick Signup (Coach)</h2>
                <form id="signup-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Email</label>
                        <input type="email" id="signup-email" required
                            class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                            placeholder="coach@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Password</label>
                        <input type="password" id="signup-password" required
                            class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                            placeholder="password">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Full Name</label>
                        <input type="text" id="signup-name" required
                            class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                            placeholder="Coach Name">
                    </div>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">
                        Sign Up as Coach
                    </button>
                </form>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">Fix Profile</h2>
                <div class="mb-4">
                    <button id="create-profile-btn"
                        class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded text-white">
                        Create Coach Profile
                    </button>
                    <p class="text-sm text-gray-400 mt-2">Click this if you see "User exists but no profile"</p>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">Actions</h2>
                <div class="space-x-4">
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white">
                        Logout
                    </button>
                    <button id="refresh-btn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white">
                        Refresh Status
                    </button>
                    <a href="create-course.html"
                        class="inline-block bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-white">
                        Test Create Course
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script type="module">
        import { auth, utils, supabase } from './supabase-client.js';

        async function updateAuthStatus() {
            const statusDiv = document.getElementById('auth-status');

            try {
                const { user, profile } = await utils.checkAuth();

                if (user && profile) {
                    statusDiv.innerHTML = `
                        <div class="text-green-400">✅ Logged in</div>
                        <div class="mt-2 text-sm">
                            <div><strong>User ID:</strong> ${user.id}</div>
                            <div><strong>Email:</strong> ${user.email}</div>
                            <div><strong>Role:</strong> ${profile.role}</div>
                            <div><strong>Name:</strong> ${profile.full_name}</div>
                        </div>
                    `;
                } else if (user && !profile) {
                    statusDiv.innerHTML = `
                        <div class="text-yellow-400">⚠️ User exists but no profile</div>
                        <div class="mt-2 text-sm">
                            <div><strong>User ID:</strong> ${user.id}</div>
                            <div><strong>Email:</strong> ${user.email}</div>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `<div class="text-red-400">❌ Not logged in</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="text-red-400">❌ Error: ${error.message}</div>`;
            }
        }

        // Login form
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const { data, error } = await auth.signIn(email, password);
                if (error) throw error;

                alert('✅ Login successful!');
                await updateAuthStatus();
            } catch (error) {
                alert('❌ Login failed: ' + error.message);
            }
        });

        // Signup form
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const fullName = document.getElementById('signup-name').value;

            try {
                const { data, error } = await auth.signUp(email, password, {
                    full_name: fullName,
                    role: 'coach'
                });
                if (error) throw error;

                alert('✅ Signup successful! You can now login.');
                await updateAuthStatus();
            } catch (error) {
                alert('❌ Signup failed: ' + error.message);
            }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await auth.signOut();
                alert('✅ Logged out');
                await updateAuthStatus();
            } catch (error) {
                alert('❌ Logout failed: ' + error.message);
            }
        });

        // Create profile for existing user
        document.getElementById('create-profile-btn').addEventListener('click', async () => {
            try {
                const { user } = await auth.getCurrentUser();
                if (!user) {
                    alert('❌ No user found. Please login first.');
                    return;
                }

                // Try using the server function first
                const { data: functionResult, error: functionError } = await supabase
                    .rpc('create_user_profile', {
                        user_id: user.id,
                        user_email: user.email,
                        user_name: user.email.split('@')[0],
                        user_role: 'coach'
                    });

                if (functionError) {
                    console.log('Function approach failed, trying direct insert...');

                    // Fallback to direct insert
                    const { data, error } = await supabase
                        .from('profiles')
                        .insert([{
                            id: user.id,
                            email: user.email,
                            full_name: user.email.split('@')[0],
                            role: 'coach'
                        }])
                        .select()
                        .single();

                    if (error) {
                        console.error('Profile creation error:', error);
                        alert('❌ Failed to create profile: ' + error.message + '\n\nPlease run the RLS policy fix in your Supabase SQL editor first.');
                        return;
                    }
                }

                alert('✅ Coach profile created successfully!');
                await updateAuthStatus();
            } catch (error) {
                console.error('Error creating profile:', error);
                alert('❌ Error: ' + error.message);
            }
        });

        // Refresh
        document.getElementById('refresh-btn').addEventListener('click', updateAuthStatus);

        // Initial status check
        updateAuthStatus();
    </script>
</body>

</html>