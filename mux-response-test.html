<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mux Response Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold mb-6 text-gray-800">Mux Response Test</h1>
        <p class="mb-6 text-gray-600">This test helps diagnose the "Unexpected end of JSON input" error by examining what the Mux upload endpoint actually returns.</p>
        
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Step 1: Get Upload URL</h2>
            <button id="getUploadUrl" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Get Mux Upload URL
            </button>
            <div id="uploadUrlResult" class="mt-4 p-4 bg-gray-50 rounded"></div>
        </div>
        
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Step 2: Test Direct Upload Response</h2>
            <p class="mb-4 text-gray-600">This will show exactly what the Mux direct upload endpoint returns.</p>
            <input type="file" id="testFile" accept="video/*" class="mb-4">
            <button id="testUpload" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" disabled>
                Test Direct Upload
            </button>
            <div id="uploadTestResult" class="mt-4 p-4 bg-gray-50 rounded"></div>
        </div>
        
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Step 3: Compare Responses</h2>
            <p class="mb-4 text-gray-600">This shows what our backend should return vs what Mux actually returns.</p>
            <button id="compareResponses" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded" disabled>
                Compare Responses
            </button>
            <div id="comparisonResult" class="mt-4 p-4 bg-gray-50 rounded"></div>
        </div>
    </div>

    <script>
        const BASE_URL = '/api';
        let uploadData = null;
        
        // Step 1: Get upload URL
        document.getElementById('getUploadUrl').addEventListener('click', async () => {
            const resultDiv = document.getElementById('uploadUrlResult');
            resultDiv.innerHTML = '<p class="text-gray-600">Getting upload URL...</p>';
            
            try {
                const response = await fetch(`${BASE_URL}/mux/upload-url`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cors_origin: window.location.origin
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                uploadData = await response.json();
                document.getElementById('testUpload').disabled = false;
                
                resultDiv.innerHTML = `
                    <p class="text-green-600 font-semibold">Success!</p>
                    <p class="mt-2">Upload ID: <code class="bg-gray-200 px-1 rounded">${uploadData.uploadId}</code></p>
                    <p class="mt-2">Upload URL: <code class="bg-gray-200 px-1 rounded break-all">${uploadData.url}</code></p>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="text-red-600 font-semibold">Error:</p>
                    <p class="text-red-500">${error.message}</p>
                `;
            }
        });
        
        // Step 2: Test direct upload response
        document.getElementById('testUpload').addEventListener('click', async () => {
            const fileInput = document.getElementById('testFile');
            const file = fileInput.files[0];
            const resultDiv = document.getElementById('uploadTestResult');
            
            if (!file) {
                alert('Please select a file first');
                return;
            }
            
            if (!uploadData) {
                alert('Please get upload URL first');
                return;
            }
            
            resultDiv.innerHTML = '<p class="text-gray-600">Uploading to Mux and capturing response...</p>';
            
            try {
                const responseInfo = await uploadToMuxAndGetResponse(file, uploadData.url);
                
                resultDiv.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <p class="text-green-600 font-semibold">Upload Status: ${responseInfo.status}</p>
                        </div>
                        <div>
                            <p class="font-semibold">Response Text:</p>
                            <pre class="mt-2 text-sm bg-gray-200 p-2 rounded max-h-40 overflow-auto">${responseInfo.responseText || '(Empty response)'}</pre>
                        </div>
                        <div>
                            <p class="font-semibold">Response Headers:</p>
                            <pre class="mt-2 text-sm bg-gray-200 p-2 rounded max-h-40 overflow-auto">${responseInfo.responseHeaders}</pre>
                        </div>
                        <div>
                            <p class="font-semibold">Can Parse as JSON:</p>
                            <p class="mt-1">${responseInfo.canParseJson ? 'Yes' : 'No'}</p>
                            ${responseInfo.parsedJson ? `
                                <p class="font-semibold mt-2">Parsed JSON:</p>
                                <pre class="mt-2 text-sm bg-gray-200 p-2 rounded max-h-40 overflow-auto">${JSON.stringify(responseInfo.parsedJson, null, 2)}</pre>
                            ` : ''}
                            ${responseInfo.parseError ? `
                                <p class="font-semibold mt-2">Parse Error:</p>
                                <p class="text-red-500">${responseInfo.parseError}</p>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.getElementById('compareResponses').disabled = false;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="text-red-600 font-semibold">Error:</p>
                    <p class="text-red-500">${error.message}</p>
                `;
            }
        });
        
        // Step 3: Compare responses
        document.getElementById('compareResponses').addEventListener('click', async () => {
            const resultDiv = document.getElementById('comparisonResult');
            resultDiv.innerHTML = '<p class="text-gray-600">Comparing responses...</p>';
            
            try {
                // Get what our backend should return for upload status
                const backendStatusResponse = await fetch(`${BASE_URL}/mux/upload/${uploadData.uploadId}`);
                const backendStatusData = backendStatusResponse.ok ? await backendStatusResponse.json() : null;
                
                // Get what our backend should return for asset details
                const simulatedAssetId = 'simulated_asset_' + uploadData.uploadId.replace('simulated_', '');
                const backendAssetResponse = await fetch(`${BASE_URL}/mux/asset/${simulatedAssetId}`);
                const backendAssetData = backendAssetResponse.ok ? await backendAssetResponse.json() : null;
                
                resultDiv.innerHTML = `
                    <div class="space-y-6">
                        <div>
                            <h3 class="font-semibold text-lg text-gray-700">What Our Backend Should Return</h3>
                            <div class="mt-2 p-3 bg-blue-50 rounded">
                                <p class="font-semibold">Upload Status Endpoint:</p>
                                <pre class="mt-2 text-sm bg-white p-2 rounded">${JSON.stringify(backendStatusData, null, 2)}</pre>
                            </div>
                            <div class="mt-3 p-3 bg-blue-50 rounded">
                                <p class="font-semibold">Asset Details Endpoint:</p>
                                <pre class="mt-2 text-sm bg-white p-2 rounded">${JSON.stringify(backendAssetData, null, 2)}</pre>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold text-lg text-gray-700">What Mux Direct Upload Actually Returns</h3>
                            <p class="mt-2 text-gray-600">Mux direct upload endpoints typically return empty responses or simple text, not JSON.</p>
                            <p class="mt-1 text-gray-600">This is why parsing the response as JSON fails with "Unexpected end of JSON input".</p>
                        </div>
                        
                        <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400">
                            <h3 class="font-semibold text-lg text-yellow-700">Solution</h3>
                            <p class="mt-2 text-yellow-700">Instead of trying to parse the direct Mux upload response as JSON, we should:</p>
                            <ol class="mt-2 list-decimal list-inside text-yellow-700 space-y-1">
                                <li>Upload to Mux (ignore the response)</li>
                                <li>Call our backend's /api/mux/upload/:uploadId endpoint to get the asset ID</li>
                                <li>Call our backend's /api/mux/asset/:assetId endpoint to get playback details</li>
                                <li>Update the lesson in Supabase with this information</li>
                            </ol>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="text-red-600 font-semibold">Error:</p>
                    <p class="text-red-500">${error.message}</p>
                `;
            }
        });
        
        function uploadToMuxAndGetResponse(file, uploadUrl) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                xhr.addEventListener('load', () => {
                    // Capture all response information
                    const responseInfo = {
                        status: xhr.status,
                        responseText: xhr.responseText,
                        responseHeaders: xhr.getAllResponseHeaders(),
                        canParseJson: false,
                        parsedJson: null,
                        parseError: null
                    };
                    
                    // Try to parse as JSON
                    if (xhr.responseText) {
                        try {
                            responseInfo.parsedJson = JSON.parse(xhr.responseText);
                            responseInfo.canParseJson = true;
                        } catch (parseError) {
                            responseInfo.parseError = parseError.message;
                        }
                    }
                    
                    resolve(responseInfo);
                });
                
                xhr.addEventListener('error', () => {
                    reject(new Error('Upload failed due to network error'));
                });
                
                xhr.open('PUT', uploadUrl);
                xhr.send(file);
            });
        }
    </script>
</body>
</html>