<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orphaned User Detection Demo - Kohza</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        purple: {
                            DEFAULT: '#9333ea', 
                            '50': '#faf5ff', 
                            '100': '#f3e8ff', 
                            '200': '#e9d5ff', 
                            '300': '#d8b4fe', 
                            '400': '#c084fc', 
                            '500': '#a855f7', 
                            '600': '#9333ea', 
                            '700': '#7e22ce', 
                            '800': '#6b21a8', 
                            '900': '#581c87', 
                            '950': '#3b0764'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .glass-effect {
            background: rgba(17, 25, 40, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .step-indicator {
            transition: all 0.3s ease;
        }

        .step-indicator.active {
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            color: white;
        }

        .step-indicator.completed {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
        }

        .step-indicator.error {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
        }

        .demo-section {
            background: rgba(17, 25, 40, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .status-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-success { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        .status-info { background-color: #3b82f6; }
        .status-processing { 
            background: linear-gradient(45deg, #9333ea, #7c3aed);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .log-entry {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            border-left: 4px solid;
        }

        .log-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #93c5fd;
        }

        .log-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            color: #6ee7b7;
        }

        .log-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #fca5a5;
        }

        .log-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
            color: #fbbf24;
        }

        .log-demo {
            background: rgba(147, 51, 234, 0.1);
            border-color: #9333ea;
            color: #c4b5fd;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white min-h-screen">
    <!-- Background Elements -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10">
        <div class="absolute w-[60vmax] h-[60vmax] -left-[30vmax] -top-[30vmax] bg-purple-900/30 rounded-full blur-3xl opacity-40"></div>
        <div class="absolute w-[50vmax] h-[50vmax] -right-[25vmax] -bottom-[25vmax] bg-purple-800/20 rounded-full blur-3xl opacity-40"></div>
    </div>

    <div class="relative z-10">
        <!-- Header -->
        <header class="glass-effect sticky top-0 z-50">
            <nav class="flex justify-between items-center w-full max-w-screen-xl mx-auto px-6 sm:px-8 py-4">
                <a href="index.html" class="text-3xl font-serif font-bold text-white hover:text-purple-400 transition-colors">Kohza</a>
                <div class="flex items-center gap-4">
                    <span class="text-purple-400 font-medium">üß™ Orphaned User Demo</span>
                    <a href="coach-admin-panel.html" class="text-gray-400 hover:text-white transition-colors">‚Üê Back to Coach Panel</a>
                </div>
            </nav>
        </header>

        <main class="max-w-screen-xl mx-auto px-6 sm:px-8 py-12">
            <!-- Page Header -->
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-serif font-bold text-white mb-4">
                    üîç Orphaned User Detection Demo
                </h1>
                <p class="text-xl text-gray-400 max-w-3xl mx-auto">
                    Test user creation scenarios and detect orphaned accounts. This demo helps identify when auth users exist without corresponding profiles.
                </p>
            </div>

            <!-- Demo Controls -->
            <div class="demo-section">
                <h2 class="text-2xl font-serif font-bold text-white mb-6">üõ†Ô∏è Demo Controls</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <button id="scan-orphaned-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        üîç Scan for Orphaned Users
                    </button>
                    <button id="create-normal-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        ‚úÖ Create Normal User
                    </button>
                    <button id="create-orphaned-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        ‚ö†Ô∏è Simulate Orphaned User
                    </button>
                    <button id="clear-logs-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        üóëÔ∏è Clear Logs
                    </button>
                </div>

                <!-- Status Display -->
                <div id="status-display" class="mb-4 p-4 bg-gray-800/50 rounded-lg">
                    <div class="flex items-center">
                        <span class="status-icon status-info"></span>
                        <span>Ready to test orphaned user scenarios</span>
                    </div>
                </div>

                <!-- User Creation Form -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Test Email</label>
                        <input type="email" id="test-email" placeholder="test@example.com" 
                               class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Full Name</label>
                        <input type="text" id="test-name" placeholder="Test User" 
                               class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Role</label>
                        <select id="test-role" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-600">
                            <option value="student">Student</option>
                            <option value="coach">Coach</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Results Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Orphaned Users Report -->
                <div class="demo-section">
                    <h3 class="text-xl font-serif font-bold text-white mb-4">üìä Orphaned Users Report</h3>
                    <div id="orphaned-report" class="space-y-4">
                        <div class="text-gray-400 text-center py-8">
                            Click "Scan for Orphaned Users" to check for orphaned accounts
                        </div>
                    </div>
                </div>

                <!-- Demo Logs -->
                <div class="demo-section">
                    <h3 class="text-xl font-serif font-bold text-white mb-4">üìù Demo Logs</h3>
                    <div id="demo-logs" class="h-96 overflow-y-auto space-y-2 bg-gray-900/50 p-4 rounded-lg">
                        <div class="log-entry log-info">
                            üìã Demo initialized. Ready to test orphaned user scenarios.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step-by-Step Process -->
            <div class="demo-section">
                <h3 class="text-xl font-serif font-bold text-white mb-6">üîÑ User Creation Process</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="step-indicator flex items-center justify-center p-4 rounded-lg border-2 border-gray-600 text-gray-400" id="step-1">
                        <div class="text-center">
                            <div class="text-2xl mb-2">1Ô∏è‚É£</div>
                            <div class="font-medium">Validate Email</div>
                        </div>
                    </div>
                    <div class="step-indicator flex items-center justify-center p-4 rounded-lg border-2 border-gray-600 text-gray-400" id="step-2">
                        <div class="text-center">
                            <div class="text-2xl mb-2">2Ô∏è‚É£</div>
                            <div class="font-medium">Create Auth User</div>
                        </div>
                    </div>
                    <div class="step-indicator flex items-center justify-center p-4 rounded-lg border-2 border-gray-600 text-gray-400" id="step-3">
                        <div class="text-center">
                            <div class="text-2xl mb-2">3Ô∏è‚É£</div>
                            <div class="font-medium">Create Profile</div>
                        </div>
                    </div>
                    <div class="step-indicator flex items-center justify-center p-4 rounded-lg border-2 border-gray-600 text-gray-400" id="step-4">
                        <div class="text-center">
                            <div class="text-2xl mb-2">4Ô∏è‚É£</div>
                            <div class="font-medium">Verify Complete</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Information Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12">
                <div class="glass-effect rounded-xl p-6 text-center">
                    <div class="text-3xl mb-3">üîç</div>
                    <h3 class="text-lg font-semibold text-white mb-2">Detection</h3>
                    <p class="text-gray-400 text-sm">Identify orphaned auth users without corresponding profiles using SQL queries</p>
                </div>
                
                <div class="glass-effect rounded-xl p-6 text-center">
                    <div class="text-3xl mb-3">‚ö†Ô∏è</div>
                    <h3 class="text-lg font-semibold text-white mb-2">Simulation</h3>
                    <p class="text-gray-400 text-sm">Test scenarios that create orphaned users to understand failure modes</p>
                </div>
                
                <div class="glass-effect rounded-xl p-6 text-center">
                    <div class="text-3xl mb-3">üõ†Ô∏è</div>
                    <h3 class="text-lg font-semibold text-white mb-2">Prevention</h3>
                    <p class="text-gray-400 text-sm">Demonstrate atomic transactions and proper error handling techniques</p>
                </div>
            </div>
        </main>

        <footer class="glass-effect mt-16">
            <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 text-center text-gray-500">
                <p>&copy; 2025 Kohza. All Rights Reserved. Forged in Discipline.</p>
                <p class="text-sm mt-2">üß™ Demo Environment - For Testing Orphaned User Detection</p>
            </div>
        </footer>
    </div>

    <script type="module">
        import { auth, supabase } from './supabase-client.js';

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üß™ Orphaned User Demo Loaded');
            
            const statusDisplay = document.getElementById('status-display');
            const logsContainer = document.getElementById('demo-logs');
            const orphanedReport = document.getElementById('orphaned-report');
            const stepIndicators = document.querySelectorAll('.step-indicator');

            // Demo state
            let currentStep = 0;

            // Utility functions
            function addLog(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const colors = {
                    info: 'log-info',
                    success: 'log-success',
                    error: 'log-error',
                    warning: 'log-warning',
                    demo: 'log-demo'
                };

                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${colors[type]}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                
                logsContainer.appendChild(logEntry);
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }

            function updateStatus(message, type = 'info') {
                const statusClasses = {
                    info: 'status-info',
                    success: 'status-success',
                    error: 'status-error',
                    warning: 'status-warning',
                    processing: 'status-processing'
                };

                statusDisplay.innerHTML = `
                    <div class="flex items-center">
                        <span class="status-icon ${statusClasses[type]}"></span>
                        <span>${message}</span>
                    </div>
                `;
            }

            function updateStep(stepNum, status) {
                const step = document.getElementById(`step-${stepNum}`);
                if (step) {
                    step.className = `step-indicator flex items-center justify-center p-4 rounded-lg border-2 text-center ${status}`;
                    if (status === 'active') {
                        step.className += ' border-purple-500';
                    } else if (status === 'completed') {
                        step.className += ' border-green-500';
                    } else if (status === 'error') {
                        step.className += ' border-red-500';
                    } else {
                        step.className += ' border-gray-600 text-gray-400';
                    }
                }
            }

            function resetSteps() {
                for (let i = 1; i <= 4; i++) {
                    updateStep(i, '');
                }
                currentStep = 0;
            }

            // Scan for orphaned users
            async function scanOrphanedUsers() {
                addLog('üîç Starting orphaned user scan...', 'demo');
                updateStatus('Scanning for orphaned users...', 'processing');

                try {
                    // Get all auth users
                    const { data: { users }, error: authError } = await supabase.auth.admin.listUsers();
                    if (authError) {
                        throw new Error(`Failed to fetch auth users: ${authError.message}`);
                    }

                    addLog(`Found ${users.length} auth users`, 'info');

                    // Check each user for orphaned status
                    const orphanedUsers = [];
                    const completeUsers = [];

                    for (const user of users) {
                        try {
                            const { data: profile, error: profileError } = await supabase
                                .from('profiles')
                                .select('*')
                                .eq('id', user.id)
                                .maybeSingle();

                            if (!profile) {
                                orphanedUsers.push(user);
                                addLog(`‚ùå ORPHANED: ${user.email} (auth exists, no profile)`, 'error');
                            } else {
                                completeUsers.push({ user, profile });
                                addLog(`‚úÖ COMPLETE: ${user.email} (auth + profile)`, 'success');
                            }
                        } catch (error) {
                            addLog(`‚ö†Ô∏è Error checking ${user.email}: ${error.message}`, 'warning');
                        }
                    }

                    // Display results
                    displayOrphanedReport(orphanedUsers, completeUsers);
                    
                    if (orphanedUsers.length > 0) {
                        updateStatus(`Found ${orphanedUsers.length} orphaned user(s)`, 'warning');
                        addLog(`üö® SCAN COMPLETE: Found ${orphanedUsers.length} orphaned users`, 'warning');
                    } else {
                        updateStatus('No orphaned users found', 'success');
                        addLog('‚úÖ SCAN COMPLETE: No orphaned users detected', 'success');
                    }

                } catch (error) {
                    addLog(`‚ùå Scan failed: ${error.message}`, 'error');
                    updateStatus('Scan failed', 'error');
                }
            }

            function displayOrphanedReport(orphanedUsers, completeUsers) {
                const reportHTML = `
                    <div class="space-y-4">
                        <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-4">
                            <h4 class="font-semibold text-red-400 mb-2">üö® Orphaned Users (${orphanedUsers.length})</h4>
                            ${orphanedUsers.length > 0 ? 
                                orphanedUsers.map(user => `
                                    <div class="text-sm text-gray-300 mb-1">
                                        üìß ${user.email} (ID: ${user.id.slice(0, 8)}...)
                                        <span class="text-red-400 text-xs ml-2">Auth exists, no profile</span>
                                    </div>
                                `).join('') :
                                '<div class="text-sm text-gray-400">No orphaned users found</div>'
                            }
                        </div>
                        
                        <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-4">
                            <h4 class="font-semibold text-green-400 mb-2">‚úÖ Complete Users (${completeUsers.length})</h4>
                            ${completeUsers.length > 0 ?
                                completeUsers.slice(0, 5).map(({user, profile}) => `
                                    <div class="text-sm text-gray-300 mb-1">
                                        üìß ${user.email} - ${profile.role}
                                        <span class="text-green-400 text-xs ml-2">Complete</span>
                                    </div>
                                `).join('') :
                                '<div class="text-sm text-gray-400">No complete users found</div>'
                            }
                            ${completeUsers.length > 5 ? `<div class="text-xs text-gray-500 mt-2">... and ${completeUsers.length - 5} more</div>` : ''}
                        </div>
                    </div>
                `;
                orphanedReport.innerHTML = reportHTML;
            }

            // Create normal user (atomic transaction)
            async function createNormalUser() {
                const email = document.getElementById('test-email').value || `test-${Date.now()}@example.com`;
                const name = document.getElementById('test-name').value || 'Test User';
                const role = document.getElementById('test-role').value || 'student';

                addLog(`üöÄ Creating normal user: ${email}`, 'demo');
                resetSteps();

                try {
                    // Step 1: Validate email
                    updateStep(1, 'active');
                    updateStatus('Validating email...', 'processing');
                    
                    if (!email.includes('@')) {
                        throw new Error('Invalid email format');
                    }
                    
                    addLog('‚úÖ Email validation passed', 'success');
                    updateStep(1, 'completed');
                    
                    // Step 2: Create auth user
                    updateStep(2, 'active');
                    updateStatus('Creating auth user...', 'processing');
                    
                    const { data: authData, error: authError } = await auth.signUp(email, 'TempPassword123!');
                    
                    if (authError) {
                        throw new Error(`Auth creation failed: ${authError.message}`);
                    }
                    
                    addLog('‚úÖ Auth user created successfully', 'success');
                    updateStep(2, 'completed');
                    
                    // Step 3: Create profile (atomic)
                    updateStep(3, 'active');
                    updateStatus('Creating profile immediately...', 'processing');
                    
                    const { data: profileData, error: profileError } = await auth.createProfile(
                        authData.user.id, 
                        email, 
                        name, 
                        role
                    );
                    
                    if (profileError) {
                        throw new Error(`Profile creation failed: ${profileError.message}`);
                    }
                    
                    addLog('‚úÖ Profile created successfully', 'success');
                    updateStep(3, 'completed');
                    
                    // Step 4: Verify complete
                    updateStep(4, 'active');
                    updateStatus('Verifying complete user...', 'processing');
                    
                    const { data: verification } = await auth.getProfile(authData.user.id);
                    if (!verification) {
                        throw new Error('Verification failed - profile not found');
                    }
                    
                    addLog('‚úÖ User creation completed successfully', 'success');
                    updateStep(4, 'completed');
                    updateStatus('Normal user created successfully', 'success');

                } catch (error) {
                    addLog(`‚ùå Normal user creation failed: ${error.message}`, 'error');
                    updateStatus('User creation failed', 'error');
                    updateStep(currentStep + 1, 'error');
                }
            }

            // Simulate orphaned user creation
            async function createOrphanedUser() {
                const email = document.getElementById('test-email').value || `orphaned-${Date.now()}@example.com`;
                
                addLog(`‚ö†Ô∏è SIMULATION: Creating orphaned user: ${email}`, 'demo');
                resetSteps();

                try {
                    // Step 1: Validate email
                    updateStep(1, 'active');
                    updateStatus('Validating email...', 'processing');
                    addLog('‚úÖ Email validation passed', 'success');
                    updateStep(1, 'completed');
                    
                    // Step 2: Create auth user
                    updateStep(2, 'active');
                    updateStatus('Creating auth user...', 'processing');
                    
                    const { data: authData, error: authError } = await supabase.auth.signUp({
                        email: email,
                        password: 'TempPassword123!'
                    });
                    
                    if (authError) {
                        throw new Error(`Auth creation failed: ${authError.message}`);
                    }
                    
                    addLog('‚úÖ Auth user created successfully', 'success');
                    updateStep(2, 'completed');
                    
                    // Step 3: SIMULATE profile creation failure
                    updateStep(3, 'active');
                    updateStatus('Simulating profile creation failure...', 'processing');
                    
                    // Intentionally skip profile creation to create orphaned user
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate processing
                    
                    addLog('‚ùå SIMULATED: Profile creation skipped/failed', 'error');
                    addLog('üö® ORPHANED USER CREATED: Auth exists but no profile', 'warning');
                    updateStep(3, 'error');
                    
                    // Step 4: Verification will fail
                    updateStep(4, 'active');
                    updateStatus('Verifying user (will fail)...', 'processing');
                    
                    const { data: verification } = await auth.getProfile(authData.user.id);
                    if (!verification) {
                        addLog('‚ùå Verification failed - no profile found (as expected)', 'error');
                        updateStep(4, 'error');
                        updateStatus('Orphaned user simulation complete', 'warning');
                    }

                } catch (error) {
                    addLog(`‚ùå Simulation error: ${error.message}`, 'error');
                    updateStatus('Simulation failed', 'error');
                }
            }

            // Event listeners
            document.getElementById('scan-orphaned-btn').addEventListener('click', scanOrphanedUsers);
            document.getElementById('create-normal-btn').addEventListener('click', createNormalUser);
            document.getElementById('create-orphaned-btn').addEventListener('click', createOrphanedUser);
            
            document.getElementById('clear-logs-btn').addEventListener('click', () => {
                logsContainer.innerHTML = '<div class="log-entry log-info">üìã Logs cleared. Ready for new tests.</div>';
                resetSteps();
                updateStatus('Ready to test orphaned user scenarios', 'info');
            });

            // Auto-generate test email
            document.getElementById('test-email').value = `test-${Date.now()}@example.com`;
            
            addLog('üéØ Demo ready! Use the buttons above to test different scenarios.', 'demo');
        });
    </script>
</body>
</html>